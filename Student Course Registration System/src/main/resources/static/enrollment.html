<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Enrollment Management</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Navigation Bar Styles */
        .navbar {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 0.5rem 0;
            position: relative;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        header {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        h1 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Enrollment Table Styles */
        .enrollment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .enrollment-table th, .enrollment-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .enrollment-table th {
            background-color: var(--dark-color);
            color: white;
        }

        .enrollment-table tr:hover {
            background-color: #f9f9f9;
        }

        .enrollment-table tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
            overflow: hidden;
            animation: modalopen 0.5s;
        }

        @keyframes modalopen {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1rem 1.5rem;
            background-color: var(--dark-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f5f5f5;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Form Styles */
        .enrollment-form {
            display: grid;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .success-message {
            display: none;
            background-color: var(--success-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .error-message {
            display: none;
            background-color: var(--accent-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .add-enrollment-btn {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }

            .navbar {
                flex-direction: column;
                padding: 1rem;
            }

            .nav-links {
                margin-top: 1rem;
                gap: 1rem;
            }

            .enrollment-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar">
    <a href="index.html" class="nav-logo">University</a>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="course.html">Courses</a>
        <a href="enrollment.html">Enrollments</a>
        <a href="support.html">Support</a>
        <a href="login.html">Logout</a>
    </div>
</nav>

<header>
    <h1>University Enrollment Management</h1>
</header>

<div class="container">
    <h2>Manage Enrollments</h2>
    <p>View and manage your course enrollments.</p>

    <button id="addEnrollmentBtn" class="btn btn-primary add-enrollment-btn">Add New Enrollment</button>

    <div id="enrollmentTableContainer">
        <table class="enrollment-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Course</th>
                    <th>Student</th>
                    <th>Email</th>
                    <th>Payment Method</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="enrollmentTableBody">
                <!-- Enrollments will be dynamically loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Enrollment Modal -->
<div id="enrollmentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add New Enrollment</h2>
            <span class="close-btn">×</span>
        </div>
        <div class="modal-body">
            <div class="success-message" id="successMessage">
                Enrollment successfully saved!
            </div>
            <div class="error-message" id="errorMessage">
                An error occurred. Please try again.
            </div>
            <form id="enrollmentForm" class="enrollment-form">
                <input type="hidden" id="enrollmentId">
                <div class="form-group">
                    <label for="courseId">Course ID</label>
                    <input type="number" id="courseId" required>
                </div>
                <div class="form-group">
                    <label for="studentId">Student ID</label>
                    <input type="text" id="studentId" required>
                </div>
                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentEmail">Student Email</label>
                    <input type="email" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod" required>
                        <option value="">Select payment method</option>
                        <option value="credit_card">Credit Card</option>
                        <option value="debit_card">Debit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="university_billing">University Billing</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancelBtn">Cancel</button>
            <button class="btn btn-primary" id="saveBtn">Save Enrollment</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <span class="close-btn">×</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this enrollment? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancelDeleteBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<script>
    // DOM Elements
    const enrollmentTableBody = document.getElementById('enrollmentTableBody');
    const enrollmentModal = document.getElementById('enrollmentModal');
    const deleteModal = document.getElementById('deleteModal');
    const closeBtns = document.querySelectorAll('.close-btn');
    const addEnrollmentBtn = document.getElementById('addEnrollmentBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const enrollmentForm = document.getElementById('enrollmentForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const modalTitle = document.getElementById('modalTitle');

    // Current enrollment ID for edit/delete operations
    let currentEnrollmentId = null;

    // Fetch and render enrollments from backend
    async function loadEnrollments() {
        try {
            const response = await fetch('http://localhost:9091/api/enrollments');
            if (!response.ok) throw new Error('Failed to fetch enrollments');
            const enrollments = await response.json();
            renderEnrollments(enrollments);
        } catch (error) {
            console.error('Error fetching enrollments:', error);
            enrollmentTableBody.innerHTML = '<tr><td colspan="6">Failed to load enrollments. Please try again later.</td></tr>';
        }
    }

    // Fetch course details by ID
    async function getCourseById(courseId) {
        try {
            const response = await fetch(`http://localhost:9091/api/courses/${courseId}`);
            if (!response.ok) throw new Error(`Failed to fetch course with ID ${courseId}`);
            return await response.json();
        } catch (error) {
            console.error(`Error fetching course ${courseId}:`, error);
            return null;
        }
    }

    // Render enrollments dynamically
    async function renderEnrollments(enrollments) {
        enrollmentTableBody.innerHTML = '';

        if (enrollments.length === 0) {
            enrollmentTableBody.innerHTML = '<tr><td colspan="6">No enrollments found.</td></tr>';
            return;
        }

        // Create a loading indicator
        enrollmentTableBody.innerHTML = '<tr><td colspan="6">Loading enrollment details...</td></tr>';

        // Process each enrollment and fetch course details
        for (const enrollment of enrollments) {
            const course = await getCourseById(enrollment.courseId);
            const courseName = course ? course.title : `Course ID: ${enrollment.courseId}`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${enrollment.id}</td>
                <td>${courseName}</td>
                <td>${enrollment.student.fullName}</td>
                <td>${enrollment.student.email}</td>
                <td>${formatPaymentMethod(enrollment.paymentMethod)}</td>
                <td class="action-buttons">
                    <button class="btn btn-outline edit-btn" data-id="${enrollment.id}">Edit</button>
                    <button class="btn btn-danger delete-btn" data-id="${enrollment.id}">Delete</button>
                </td>
            `;

            // Clear loading indicator on first iteration
            if (enrollmentTableBody.innerHTML.includes('Loading')) {
                enrollmentTableBody.innerHTML = '';
            }

            enrollmentTableBody.appendChild(row);
        }

        // Add event listeners to the edit and delete buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.target.getAttribute('data-id'));
                openEditModal(id);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.target.getAttribute('data-id'));
                openDeleteModal(id);
            });
        });
    }

    // Format payment method for display
    function formatPaymentMethod(method) {
        return method.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Event Listeners
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            enrollmentModal.style.display = 'none';
            deleteModal.style.display = 'none';
            resetForm();
        });
    });

    addEnrollmentBtn.addEventListener('click', () => {
        modalTitle.textContent = 'Add New Enrollment';
        currentEnrollmentId = null;
        enrollmentModal.style.display = 'block';
        resetForm();
    });

    cancelBtn.addEventListener('click', () => {
        enrollmentModal.style.display = 'none';
        resetForm();
    });

    cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.style.display = 'none';
    });

    saveBtn.addEventListener('click', async () => {
        if (enrollmentForm.checkValidity()) {
            try {
                const courseId = parseInt(document.getElementById('courseId').value);
                const studentId = document.getElementById('studentId').value;
                const studentName = document.getElementById('studentName').value;
                const studentEmail = document.getElementById('studentEmail').value;
                const paymentMethod = document.getElementById('paymentMethod').value;

                const enrollmentData = {
                    courseId: courseId,
                    student: {
                        studentId: studentId,
                        fullName: studentName,
                        email: studentEmail
                    },
                    paymentMethod: paymentMethod
                };

                let response;

                if (currentEnrollmentId) {
                    // Update existing enrollment
                    enrollmentData.id = currentEnrollmentId;
                    response = await fetch(`http://localhost:9091/api/enrollments/${currentEnrollmentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(enrollmentData)
                    });
                } else {
                    // Create new enrollment
                    response = await fetch('http://localhost:9091/api/enrollments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(enrollmentData)
                    });
                }

                if (!response.ok) throw new Error('Failed to save enrollment');

                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';

                // Reload enrollments after successful save
                loadEnrollments();

                // Hide success message and modal after 2 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                    enrollmentModal.style.display = 'none';
                    resetForm();
                }, 2000);
            } catch (error) {
                console.error('Error saving enrollment:', error);
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
                errorMessage.textContent = 'Failed to save enrollment. Please try again.';
            }
        } else {
            enrollmentForm.reportValidity();
        }
    });

    confirmDeleteBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`http://localhost:9091/api/enrollments/${currentEnrollmentId}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete enrollment');

            // Reload enrollments after successful delete
            loadEnrollments();

            // Hide delete modal
            deleteModal.style.display = 'none';
        } catch (error) {
            console.error('Error deleting enrollment:', error);
            alert('Failed to delete enrollment. Please try again.');
        }
    });

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === enrollmentModal) {
            enrollmentModal.style.display = 'none';
            resetForm();
        }
        if (e.target === deleteModal) {
            deleteModal.style.display = 'none';
        }
    });

    // Functions
    async function openEditModal(id) {
        try {
            const response = await fetch(`http://localhost:9091/api/enrollments/${id}`);
            if (!response.ok) throw new Error('Failed to fetch enrollment details');
            const enrollment = await response.json();

            currentEnrollmentId = enrollment.id;
            modalTitle.textContent = 'Edit Enrollment';

            document.getElementById('enrollmentId').value = enrollment.id;
            document.getElementById('courseId').value = enrollment.courseId;
            document.getElementById('studentId').value = enrollment.student.studentId;
            document.getElementById('studentName').value = enrollment.student.fullName;
            document.getElementById('studentEmail').value = enrollment.student.email;
            document.getElementById('paymentMethod').value = enrollment.paymentMethod;

            enrollmentModal.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        } catch (error) {
            console.error('Error fetching enrollment details:', error);
            alert('Failed to load enrollment details. Please try again.');
        }
    }

    function openDeleteModal(id) {
        currentEnrollmentId = id;
        deleteModal.style.display = 'block';
    }

    function resetForm() {
        enrollmentForm.reset();
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';
    }

    // Load enrollments on page load
    document.addEventListener('DOMContentLoaded', loadEnrollments);
</script>
</body>
</html>
